<%= error_messages_for 'settings_template' %>

<div class="box tabular">
  <p><label for="settings_template_name"><%= l(:field_name) %><span class="required"> *</span></label>
    <%= text_field 'settings_template', 'name' %></p>
</div>

<div class="intouch-settings">
  <div>
    <h3><%= l('intouch.label.telegram') %></h3>

    <div class="box">
      <table>
        <thead>
        <tr>
          <th><%= l "intouch.recipient.title" %></th>
          <% %w(author assigned_to watchers user_groups).each do |recipient| %>
            <th><%= l "intouch.recipient.#{recipient}" %></th>
          <% end %>
        </tr>
        </thead>
        <% %w(alarm new working feedback overdue).each do |notice| %>
          <tr>
            <th><%= l "intouch.statuses.#{notice}" %></th>
            <% %w(author assigned_to watchers).each do |receiver| %>
              <td class="center">
                <%= check_box_tag "settings_template[intouch_settings][telegram_settings][#{notice}][#{receiver}]", '1',
                                  @settings_template.telegram_settings.try(:[], notice).try(:[], receiver) %>
              </td>

            <% end %>
            <td>
              <% Group.find_each do |user_group| %>
                <%= check_box_tag "settings_template[intouch_settings][telegram_settings][#{notice}][user_groups][#{user_group.id}]", '1',
                                  @settings_template.telegram_settings.try(:[], notice).try(:[], 'user_groups').try(:[], user_group.id.to_s) %>
                <%= label_tag user_group.name %><br>
              <% end %>
            </td>
          </tr>
        <% end %>

      </table>
      <h4><%= l "intouch.recipient.telegram_groups" %></h4>

      <% TelegramGroupChat.find_each do |telegram_group| %>
        <h5><%= telegram_group.title %></h5>
        <table>
          <thead>
          <tr>
            <th>Статус \ Приоритет</th>
            <% IssuePriority.order(:position).each do |priority| %>
              <th><%= priority.name %></th>
            <% end %>
          </tr>
          </thead>
          <tbody>
          <% IssueStatus.order(:position).each do |status| %>
            <tr>
              <th>
                <%= status.name %>
              </th>
              <% IssuePriority.order(:position).each do |priority| %>
                <td>
                  <%= check_box_tag "settings_template[intouch_settings][telegram_settings][groups][#{telegram_group.id}][#{status.id}][]", priority.id,
                                    @settings_template.telegram_settings.try(:[], 'groups').try(:[], telegram_group.id.to_s).
                                        try(:[], status.id.to_s).try(:include?, priority.id.to_s) %>
                </td>

              <% end %>
            </tr>


          <% end %>
          </tbody>
        </table>
      <% end %>
    </div>

  </div>

  <div>
    <h3><%= l('intouch.label.email') %></h3>

    <div class="box">
      <p>
        <label for="email_cc"><%= l "intouch.email.cc_to" %></label>
        <%= select_tag('settings_template[intouch_settings][email_settings][cc]',
                       options_for_select(User.all.collect { |u| [u.name, u.mail] }, @settings_template.email_settings.try(:[], 'cc')),
                       include_blank: true) %>
      </p>

      <p>
        <%= @settings_template.email_settings.try(:[], 'cc') %>
      </p>

      <table>
        <thead>
        <tr>
          <th><%= l "intouch.recipient.title" %></th>
          <% %w(author assigned_to watchers user_groups).each do |recipient| %>
            <th><%= l "intouch.recipient.#{recipient}" %></th>
          <% end %>
        </tr>
        </thead>

        <% %w(alarm new working feedback overdue).each do |notice| %>
          <tr>
            <th><%= l "intouch.statuses.#{notice}" %></th>
            <% %w(author assigned_to watchers).each do |receiver| %>
              <td class="center">
                <%= check_box_tag "settings_template[intouch_settings][email_settings][#{notice}][#{receiver}]", '1',
                                  @settings_template.email_settings.try(:[], notice).try(:[], receiver) %>
              </td>

            <% end %>
            <td>
              <% Group.find_each do |user_group| %>
                <%= check_box_tag "settings_template[intouch_settings][email_settings][#{notice}][user_groups][#{user_group.id}]", '1',
                                  @settings_template.email_settings.try(:[], notice).try(:[], 'user_groups').try(:[], user_group.id.to_s) %>
                <%= label_tag user_group.name %><br>
              <% end %>
            </td>
          </tr>
        <% end %>
      </table>
    </div>
  </div>
</div>
